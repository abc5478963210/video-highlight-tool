import axios from 'axios'

// æ ¹æ“šç’°å¢ƒè‡ªå‹•åˆ¤æ–· API URL
const getApiBaseURL = () => {
  const envApiUrl = import.meta.env.VITE_APP_API_BASE_URL
  const useMock = import.meta.env.DEV || import.meta.env.VITE_MOCK === 'true'
  
  // é–‹ç™¼ç’°å¢ƒï¼šä½¿ç”¨ç’°å¢ƒè®Šæ•¸æˆ–é»˜èª localhost
  if (import.meta.env.DEV) {
    // å¦‚æœä½¿ç”¨ MSW mockï¼Œä½¿ç”¨ç›¸å°è·¯å¾‘ï¼ˆè®“ MSW æ””æˆªï¼‰
    if (useMock && !envApiUrl) {
      return '' // ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä½¿ç”¨ç›¸å°è·¯å¾‘
    }
    return envApiUrl || 'http://localhost:8081'
  }
  
  // ç”Ÿç”¢ç’°å¢ƒ
  if (useMock) {
    // å¦‚æœç”Ÿç”¢ç’°å¢ƒä¹Ÿä½¿ç”¨ mockï¼Œä½¿ç”¨ç›¸å°è·¯å¾‘ï¼ˆè®“ MSW æ””æˆªï¼‰
    console.log('âœ… ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨ MSW Mockï¼ŒAPI ä½¿ç”¨ç›¸å°è·¯å¾‘')
    return '' // ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä½¿ç”¨ç›¸å°è·¯å¾‘ï¼ŒMSW æœƒæ””æˆªè«‹æ±‚
  }
  
  // ç”Ÿç”¢ç’°å¢ƒï¼šå¿…é ˆä½¿ç”¨æœ‰æ•ˆçš„ API URL
  if (envApiUrl) {
    // æª¢æŸ¥æ˜¯å¦ç‚º localhostï¼ˆç”Ÿç”¢ç’°å¢ƒä¸æ‡‰è©²ä½¿ç”¨ localhostï¼Œé™¤éä½¿ç”¨ mockï¼‰
    if ((envApiUrl.includes('localhost') || envApiUrl.includes('127.0.0.1')) && !useMock) {
      console.error('âŒ éŒ¯èª¤ï¼šç”Ÿç”¢ç’°å¢ƒä¸èƒ½ä½¿ç”¨ localhostï¼')
      console.error('è«‹è¨­ç½® .env.production æ–‡ä»¶ï¼Œä½¿ç”¨å¯¦éš›çš„ API æœå‹™å™¨åœ°å€')
      console.error('æˆ–è¨­ç½® VITE_MOCK=true ä¾†ä½¿ç”¨ MSW mock')
      console.error('ç¯„ä¾‹ï¼šVITE_APP_API_BASE_URL=https://api.yourdomain.com')
    } else {
      console.log('âœ… ä½¿ç”¨ç”Ÿç”¢ç’°å¢ƒ API URL:', envApiUrl)
      return envApiUrl
    }
  }
  
  // ç”Ÿç”¢ç’°å¢ƒå¾Œå‚™é…ç½®ï¼ˆå¦‚æœæ²’æœ‰è¨­ç½®ç’°å¢ƒè®Šæ•¸ä¸”ä¸ä½¿ç”¨ mockï¼‰
  // âš ï¸ è«‹åœ¨ä¸‹æ–¹å¡«å…¥ä½ çš„å¯¦éš› API æœå‹™å™¨åœ°å€
  // ä¾‹å¦‚ï¼š'https://api.yourdomain.com' æˆ– 'https://your-backend.herokuapp.com'
  const PRODUCTION_API_URL = '' // ğŸ‘ˆ è«‹åœ¨é€™è£¡å¡«å…¥ä½ çš„å¯¦éš› API URL
  
  if (PRODUCTION_API_URL) {
    console.log('âœ… ä½¿ç”¨å¾Œå‚™ç”Ÿç”¢ç’°å¢ƒ API URL:', PRODUCTION_API_URL)
    return PRODUCTION_API_URL
  }
  
  // å¦‚æœæ²’æœ‰è¨­ç½®ä¸”ä¸ä½¿ç”¨ mockï¼Œçµ¦å‡ºæ˜ç¢ºçš„éŒ¯èª¤æç¤º
  if (!useMock) {
    console.error('âŒ éŒ¯èª¤ï¼šç”Ÿç”¢ç’°å¢ƒæœªè¨­ç½® API URLï¼')
    console.error('è«‹å‰µå»º .env.production æ–‡ä»¶ä¸¦è¨­ç½® VITE_APP_API_BASE_URL')
    console.error('æˆ–è¨­ç½® VITE_MOCK=true ä¾†ä½¿ç”¨ MSW mock')
    console.error('æˆ–åœ¨ src/api/index.ts ä¸­è¨­ç½® PRODUCTION_API_URL è®Šæ•¸')
  }
  
  // å¦‚æœä½¿ç”¨ mockï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆç›¸å°è·¯å¾‘ï¼‰
  return ''
}

const apiBaseURL = getApiBaseURL()

// å§‹çµ‚é¡¯ç¤ºç•¶å‰ä½¿ç”¨çš„ API URLï¼ˆæ–¹ä¾¿èª¿è©¦ï¼‰
console.log('ğŸ”— API Base URL:', apiBaseURL || '(æœªè¨­ç½®)')
if (!apiBaseURL && !import.meta.env.DEV) {
  console.error('âŒ ç”Ÿç”¢ç’°å¢ƒ API URL æœªæ­£ç¢ºè¨­ç½®ï¼è«‹æª¢æŸ¥ç’°å¢ƒè®Šæ•¸é…ç½®ã€‚')
}

const api = axios.create({
  baseURL: apiBaseURL,
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json'
  },
  // è™•ç†è·¨åŸŸè«‹æ±‚
  withCredentials: false // æ ¹æ“šå¾Œç«¯éœ€æ±‚è¨­ç½®ï¼Œå¦‚æœå¾Œç«¯éœ€è¦ cookies å‰‡è¨­ç‚º true
})

// è«‹æ±‚æ””æˆªå™¨
api.interceptors.request.use(
  (config) => {
    const fullUrl = config.baseURL ? `${config.baseURL}${config.url}` : config.url
    console.log('ğŸš€ ç™¼é€è«‹æ±‚:', fullUrl)
    
    // å¦‚æœæ˜¯ FormDataï¼Œç§»é™¤ Content-Type è®“ç€è¦½å™¨è‡ªå‹•è¨­ç½®
    if (config.data instanceof FormData) {
      delete config.headers['Content-Type']
    }
    
    // ç¢ºä¿è«‹æ±‚é ­è¨­ç½®æ­£ç¢º
    if (!config.headers['Content-Type'] && !(config.data instanceof FormData)) {
      config.headers['Content-Type'] = 'application/json'
    }
    
    return config
  },
  (error) => {
    console.error('âŒ è«‹æ±‚éŒ¯èª¤:', error)
    return Promise.reject(error)
  }
)

// éŸ¿æ‡‰æ””æˆªå™¨
api.interceptors.response.use(
  (response) => {
    console.log('âœ… è«‹æ±‚æˆåŠŸ:', response.config.url)
    return response
  },
  (error) => {
    console.error('âŒ éŸ¿æ‡‰éŒ¯èª¤:', error)
    
    // è™•ç† CORS éŒ¯èª¤
    if (error.message === 'Network Error' || error.code === 'ERR_NETWORK') {
      console.error('âš ï¸ CORS éŒ¯èª¤ï¼šè«‹æª¢æŸ¥å¾Œç«¯æœå‹™å™¨çš„ CORS è¨­ç½®')
      error.message = 'ç¶²è·¯éŒ¯èª¤ï¼šè«‹ç¢ºèª API æœå‹™å™¨å·²æ­£ç¢ºè¨­ç½® CORS é ­'
    }
    
    // è™•ç†è·¨åŸŸç›¸é—œéŒ¯èª¤
    if (error.response?.status === 0 || error.code === 'ERR_CORS') {
      console.error('âš ï¸ è·¨åŸŸè«‹æ±‚è¢«é˜»æ­¢ï¼šè«‹æª¢æŸ¥å¾Œç«¯ CORS é…ç½®')
      error.message = 'è·¨åŸŸè«‹æ±‚å¤±æ•—ï¼šè«‹ç¢ºèªå¾Œç«¯æœå‹™å™¨å…è¨±ä¾†è‡ªç•¶å‰åŸŸåçš„è«‹æ±‚'
    }
    
    return Promise.reject(error)
  }
)

export default api